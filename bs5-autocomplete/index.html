<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Bootstrap demo</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
</head>

<body>
	<div class="container mt-5">
		<div class="row">
			<div class="col-md-6">
				<form action="">

					<div class="mt-3">
						<label class="form-label">Chọn một công ty</label>
						<input type="text" id="companyId" readonly class="form-control">
					</div>

					<div class="mt-3">
						<label class="form-label">Chọn 1 công ty (liên kết với textbox ở trên)</label>
						<div class="dropdown bs5-dropdown" x-data="bs5autocomplete(['id', 'companyName'], 1)"
							data-output-ele="#companyId" data-uri="json/company.json">
							<button class="form-control text-start dropdown-toggle" type="button"
								data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false"
								x-text="_setting.text">
								...
							</button>
							<div class="dropdown-menu">
								<template x-for="item in _data">
									<div class="d-flex">
										<a class="dropdown-item" href="#" x-on:click="toggleCheckbox(item)">
											<label class="px-3 pt-1" x-on:click.stop>
												<input type="checkbox" :checked="item.selected" x-model="item.selected">
											</label>
											<span x-text="item.text"></span>
										</a>
									</div>
								</template>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
	<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

	<script>
		/**
		 * addAlpineData
		 * 
		 * @param   name    {string}
		 * @param   data    {object}
		 * @param   params  {object}
		 */
		function addAlpineData(name, data = {}) {
			document.addEventListener('alpine:init', function () {
				Alpine.data(name, function (...params) {
					data.$params = params;
					return data;
				});
			});
		}

		addAlpineData('bs5autocomplete', {
			_setting: {
				minCharsToFind: 2,
				placeholder: 'Nhập ít nhất {num} ký tự để tìm kiếm',
				text: '-- Chọn một giá trị --',	// Đặt text mặc định để không bị thay đổi layout quá nhiều
				maxHeight: '300px',
			},
			// dropdown dưới dạng JS object để dễ xử lý
			_dropdown: {},

			/**
			 * mảng chứa object với cấu trúc như sau
			 *		value
			 *		text
			 *		selected
			 **/
			_data: [],

			/**
			 * Định nghĩa mảng các key để chuyển đổi dữ liệu theo nguyên tắc
			 *		0	=>	value
			 *		1	=>	text
			 **/
			_mapper: [],
			getSelectedValue() {
				return this._data.filter(i => i.selected == true)?.pop().value;
			},
			setSelectedValue(...value) {
				for (let i = 0; i < this.data.length; i++) {
					const item = array[i];
					item.selected = value.indexOf(item.value) >= 0;
				}
			},
			toggleCheckbox(item) {
				item.selected = !item.selected;
			},

			// constructor
			init() {
				let uri = this.$el.getAttribute("data-uri");
				let output = document.querySelector(this.$el.getAttribute("data-output-ele"));
				let selectedValues = this.$params[1];

				this._dropdown = new bootstrap.Dropdown(this.$el);
				this._mapper = this.$params[0];
				this._setting.placeholder = this._setting.placeholder.replace("{num}", this._setting.minCharsToFind);

				// Nhận data từ uri
				fetch(uri).then(res => res.json())
					.then(json => {
						if (json) {
							json.forEach(item => {
								let strValue = item[this._mapper[0]].toString();
								let dataItem = {
									value: strValue,
									text: item[this._mapper[1]]
								};

								if (typeof (selectedValues) == "string" || typeof (selectedValues) == "number") {
									dataItem.selected = strValue == selectedValues;
								} else {
									dataItem.selected = selectedValues ? selectedValues.findIndex(s => s == strValue) >= 0 : false
								}
								this._data.push(dataItem);
							});
						}
					});

				// watch giá trị để cập nhật textbox output & text hiển thị khi có thay đổi
				this.$watch("_data", (value) => {
					let selecteds = value.filter(x => x.selected);
					output.value = selecteds.map(x => x.value).join(',');
					if (!selecteds || selecteds.length == 0) {
						this._setting.text = "-- Chọn một giá trị --";
					} else if (selecteds.length == 1) {
						this._setting.text = selecteds[0].text;
					} else {
						this._setting.text = `${selecteds.length} giá trị được chọn`;
					}
				});
			}
		});
	</script>
</body>

</html>